<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Control y Seguimiento - Operaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
   
    <style>
        /* Estilos personalizados (mantenidos iguales) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* bg-slate-100 */
        }
        .kanban-column {
            display: flex; /* A√±adido para que la columna sea flex y su contenido se estire */
            flex-direction: column; /* Contenido en columna */
            max-height: 600px; /* Altura m√°xima para las columnas Kanban antes de hacer scroll */
        }
        .task-container {
            flex-grow: 1; /* Permite que el contenedor de tareas ocupe el espacio disponible */
            overflow-y: auto; /* Barra lateral de desplazamiento vertical para las tareas */
            padding-right: 8px; /* Espacio para la barra de desplazamiento */
        }
        /* Estilo para la barra de desplazamiento de las columnas Kanban */
        .task-container::-webkit-scrollbar {
            width: 8px;
        }
        .task-container::-webkit-scrollbar-track {
            background: #e2e8f0; /* bg-slate-200 */
            border-radius: 10px;
        }
        .task-container::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
        }
        .task-container::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        .task-card {
            cursor: grab;
            transition: background-color 0.2s, box-shadow 0.2s;
            position: relative; /* Necesario para posicionar el bot√≥n de eliminar */
        }
        .task-card:active {
            cursor: grabbing;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .dragging {
            opacity: 0.1; /* Opacidad para la tarjeta que se est√° arrastrando */
        }
        .drag-over {
            background-color: rgba(59, 130, 246, 0.1); /* bg-blue-500 con opacidad */
            border: 2px dashed rgba(59, 130, 246, 0.4); /* border-blue-500 con opacidad */
        }
        .chart-container {
            height: 250px; /* Altura base para contenedores de gr√°ficos */
        }
        /* Estilos para el men√∫ contextual */
        #contextMenu {
            position: absolute;
            display: none;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px 0;
            z-index: 1000;
            min-width: 150px;
        }
        #contextMenu button {
            display: block;
            width: 100%;
            padding: 8px 16px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        #contextMenu button:hover {
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* Estilos para las etiquetas de estado en la tabla */
        .status-badge {
            display: inline-block;
            padding: 0.2em 0.6em;
            font-size: 0.75em;
            font-weight: 600;
            border-radius: 9999px; /* rounded-full */
            color: white;
        }
        /* Estilo para la barra de desplazamiento de la tabla */
        #task-table-wrapper {
            max-height: 400px; /* Altura m√°xima para la tabla antes de hacer scroll */
            overflow-y: auto;
            padding-right: 8px; /* Espacio para la barra de desplazamiento */
        }
        #task-table-wrapper::-webkit-scrollbar {
            width: 8px;
        }
        #task-table-wrapper::-webkit-scrollbar-track {
            background: #e2e8f0; /* bg-slate-200 */
            border-radius: 10px;
        }
        .task-table-wrapper::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
        }
        .task-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        /* Estilos para el bot√≥n de eliminar en la tarjeta */
        .task-card .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: none;
            border: none;
            color: #ef4444; /* red-500 */
            font-size: 1.1em;
            cursor: pointer;
            opacity: 0; /* Oculto por defecto */
            transition: opacity 0.2s ease-in-out;
            padding: 4px;
            border-radius: 50%;
            display: flex; /* Para centrar el SVG */
            align-items: center;
            justify-content: center;
            z-index: 10; /* Asegura que est√© por encima del contenido de la tarjeta */
        }
        .task-card:hover .delete-btn {
            opacity: 1; /* Visible al pasar el rat√≥n */
        }
        .task-card .delete-btn:hover {
            background-color: rgba(239, 68, 68, 0.1); /* red-500 con 10% de opacidad */
        }
        /* Estilos para fecha l√≠mite pasada */
        .task-card.deadline-passed {
            border-left-color: #ef4444 !important; /* Sobrescribe el color de categor√≠a */
        }

        /* Nuevos estilos para login */
        #loginModal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        #loginForm {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        #mainContent {
            display: none; /* Oculto hasta login exitoso */
        }

        /* Estilos para modal de detalles de tarea */
        #taskDetailModal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        #taskDetailContent {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Estilos para secci√≥n de √∫ltimas tareas (siempre visible, arriba del bot√≥n) */
        .last-tasks-section {
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="text-slate-800">
    <!-- Modal de Login -->
    <div id="loginModal">
        <form id="loginForm" class="bg-white rounded-lg shadow-2xl p-8">
            <div class="text-center mb-6">
                <img src="https://res.cloudinary.com/dway4iqeh/image/upload/v1763209064/logo_z1ffik.png" alt="Logo" class="mx-auto h-24 w-auto">
            </div>
            <h2 class="text-2xl font-bold mb-6 text-center">Iniciar Sesi√≥n</h2>
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-slate-700 mb-1">Usuario</label>
                <input type="text" id="username" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-slate-700 mb-1">Contrase√±a</label>
                <input type="password" id="password" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Ingresar</button>
        </form>
    </div>

    <!-- Contenido Principal (oculto inicialmente) -->
    <div id="mainContent" class="container mx-auto p-4 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Tablero de Control y Foco</h1>
            <p class="text-slate-600 mt-2">Herramienta para la gesti√≥n de prioridades de Operaciones</p>
        </header>
        <div class="flex flex-col items-center mb-8">
            <!-- Secci√≥n de √∫ltimas 2 tareas (siempre visible, arriba del bot√≥n) -->
            <div id="lastTasksSection" class="last-tasks-section">
                <h3 class="font-bold text-sm mb-2">√öltimas 2 Tareas Agregadas</h3>
                <ul id="lastTasksList" class="space-y-2"></ul>
            </div>
            <button id="addTaskBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                A√±adir Nueva Tarea
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div id="backlog" class="bg-slate-200 rounded-lg p-4 kanban-column">
                <h2 class="font-bold text-lg mb-4 text-slate-700 text-center">Asignado</h2>
                <div id="backlog-tasks" class="space-y-2 task-container"></div>
            </div>
            <div id="focus" class="bg-slate-200 rounded-lg p-4 kanban-column">
                <h2 class="font-bold text-lg mb-4 text-slate-700 text-center">Recibido</h2>
                <div id="focus-tasks" class="space-y-2 task-container"></div>
            </div>
            <div id="progress" class="bg-slate-200 rounded-lg p-4 kanban-column">
                <h2 class="font-bold text-lg mb-4 text-slate-700 text-center">En Progreso</h2>
                <div id="progress-tasks" class="space-y-2 task-container"></div>
            </div>
            <div id="done" class="bg-slate-200 rounded-lg p-4 kanban-column">
                <h2 class="font-bold text-lg mb-4 text-slate-700 text-center">Finalizado</h2>
                <div id="done-tasks" class="space-y-2 task-container"></div>
            </div>
        </div>
        <section class="mt-12">
            <h2 class="text-2xl font-bold text-slate-900 mb-6 text-center">Dashboard Estad√≠stico</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-slate-800 p-4 rounded-lg shadow-lg">
                    <h3 class="font-semibold text-lg mb-4 text-slate-200 text-center">Resumen por Estado</h3>
                    <div class="chart-container"><canvas id="statusChart"></canvas></div>
                </div>
                <div class="bg-slate-800 p-4 rounded-lg shadow-lg">
                    <h3 class="font-semibold text-lg mb-4 text-slate-200 text-center">Tareas por Responsable</h3>
                    <div class="chart-container"><canvas id="assigneeChart"></canvas></div>
                </div>
                <div class="bg-slate-800 p-4 rounded-lg shadow-lg">
                    <h3 class="font-semibold text-lg mb-4 text-slate-200 text-center">Estado de Avance por Responsable</h3>
                    <div class="chart-container"><canvas id="progressByAssigneeChart"></canvas></div>
                </div>
                <div class="bg-slate-800 p-4 rounded-lg shadow-lg">
                    <h3 class="font-semibold text-lg mb-4 text-slate-200 text-center">Estad√≠stico de Resultados (Tasa de Finalizaci√≥n)</h3>
                    <div class="chart-container"><canvas id="completionRateChart"></canvas></div>
                </div>
            </div>
        </section>
        <section class="mt-12">
            <h2 class="text-2xl font-bold text-slate-900 mb-6 text-center">Estad√≠sticas Mensuales de Tareas</h2>
            <div class="bg-slate-800 p-4 rounded-lg shadow-lg w-full">
                <h3 class="font-semibold text-lg mb-4 text-slate-200 text-center">Tareas Creadas y Finalizadas Mensualmente</h3>
                <div class="chart-container h-[300px] md:h-[400px]"> <canvas id="monthlyTasksChart"></canvas>
                </div>
            </div>
        </section>
        <section class="mt-12">
            <h2 class="text-2xl font-bold text-slate-900 mb-6 text-center">Planilla de Gesti√≥n de Tareas</h2>
            <div class="bg-white p-4 rounded-lg shadow-lg overflow-x-auto" id="task-table-wrapper">
                <label for="filtro-responsable" class="block text-sm font-medium text-slate-700 mb-2">Filtrar por Responsable:</label>
                <input type="text" id="filtro-responsable" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 mb-4" placeholder="Ej: Operaciones" onkeyup="filtrarTablaPorResponsable()">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0 bg-white z-10">
                        <tr>
                            <th scope="col" class="px-6 py-3">Tarea</th>
                            <th scope="col" class="px-6 py-3">Responsable</th>
                            <th scope="col" class="px-6 py-3">Solicitante</th>
                            <th scope="col" class="px-6 py-3">Fecha Asignaci√≥n</th>
                            <th scope="col" class="px-6 py-3">Fecha L√≠mite</th>
                            <th scope="col" class="px-6 py-3">Fecha Finalizaci√≥n</th>
                            <th scope="col" class="px-6 py-3">Categor√≠a</th>
                            <th scope="col" class="px-6 py-3">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="task-table-body"></tbody>
                </table>
            </div>
        </section>
    </div>
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md overflow-y-auto max-h-[80vh]">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6">A√±adir Tarea</h2>
            <form id="taskForm">
                <input type="hidden" id="task-id">
                <input type="hidden" id="task-creation-date">
                <input type="hidden" id="task-completion-date">
                <div class="mb-4">
                    <label for="taskTitle" class="block text-sm font-medium text-slate-700 mb-1">T√≠tulo</label>
                    <input type="text" id="taskTitle" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="taskDesc" class="block text-sm font-medium text-slate-700 mb-1">Descripci√≥n</label>
                    <textarea id="taskDesc" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="mb-4">
                    <label for="taskResponsible" class="block text-sm font-medium text-slate-700 mb-1">Responsable</label>
                    <select id="taskResponsible" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="" disabled selected>Selecciona un responsable</option>
                        <option value="Branch">Branch</option>
                        <option value="J. Servicio">J. Servicio</option>
                        <option value="Comercial">Comercial</option>
                        <option value="Operaciones">Operaciones</option>
                        <option value="Acreditaci√≥n GGSS">Acreditaci√≥n GGSS</option>
                        <option value="OS10">OS10</option>
                        <option value="SES">SES</option>
                        <option value="RRHH">RRHH</option>
                        <option value="Finanzas">Finanzas</option>
                        <option value="Log√≠stica">Log√≠stica</option>
                        <option value="Planner">Planner</option>
                        <option value="PPRR">PPRR</option>
                        <option value="Acreditaci√≥n RRHH">Acreditaci√≥n RRHH</option>
                        <option value="AP. VISION">AP. VISION</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="taskRequester" class="block text-sm font-medium text-slate-700 mb-1">Solicitante</label>
                    <select id="taskRequester" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="" disabled selected>Selecciona un solicitante</option>
                        <option value="Branch">Branch</option>
                        <option value="J. Servicio">J. Servicio</option>
                        <option value="Comercial">Comercial</option>
                        <option value="Operaciones">Operaciones</option>
                        <option value="Acreditaci√≥n GGSS">Acreditaci√≥n GGSS</option>
                        <option value="OS10">OS10</option>
                        <option value="SES">SES</option>
                        <option value="RRHH">RRHH</option>
                        <option value="Finanzas">Finanzas</option>
                        <option value="Log√≠stica">Log√≠stica</option>
                        <option value="Planner">Planner</option>
                        <option value="PPRR">PPRR</option>
                        <option value="Acreditaci√≥n RRHH">Acreditaci√≥n RRHH</option>
                        <option value="AP. VISION">AP. VISION</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="taskDeadline" class="block text-sm font-medium text-slate-700 mb-1">Fecha L√≠mite</label>
                    <input type="date" id="taskDeadline" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="taskCategory" class="block text-sm font-medium text-slate-700 mb-1">Categor√≠a</label>
                    <select id="taskCategory" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="assigned">Asignado</option>
                        <option value="received">Recibido</option>
                        <option value="in_process">En Proceso</option>
                        <option value="finished">Finalizado</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelBtn" class="px-4 py-2 bg-slate-200 rounded-md hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para detalles de tarea -->
    <div id="taskDetailModal">
        <div id="taskDetailContent" class="bg-white rounded-lg shadow-2xl p-8">
            <h2 class="text-2xl font-bold mb-6">Detalles de la Tarea</h2>
            <div id="taskDetailBody"></div>
            <div class="flex justify-end mt-6">
                <button id="closeDetailBtn" class="px-4 py-2 bg-slate-200 rounded-md hover:bg-slate-300">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="contextMenu">
        <button id="editTaskBtn">‚úèÔ∏è Editar Tarea</button>
        <button id="deleteTaskBtn">üóëÔ∏è Eliminar Tarea</button>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const taskModal = document.getElementById('taskModal');
            const taskForm = document.getElementById('taskForm');
            const contextMenu = document.getElementById('contextMenu');
            const loginModal = document.getElementById('loginModal');
            const loginForm = document.getElementById('loginForm');
            const mainContent = document.getElementById('mainContent');
            const taskDetailModal = document.getElementById('taskDetailModal');
            const closeDetailBtn = document.getElementById('closeDetailBtn');
           
            let charts = {};
            let currentContextMenuTask = null; // Para el men√∫ contextual
            let draggedItem = null;
           
            // ¬°IMPORTANTE! Esta es la URL de tu Google Apps Script
            const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxqps6yuTqFzzE7e6hP-GowZWY9w-DKt_inKxNvZWTo-wfapeAijyFnlgQtSyoj5xHc/exec';
            // CATEGOR√çAS ACTUALIZADAS SEG√öN TU SOLICITUD
            const categoryMap = {
                'assigned': { label: 'Asignado', color: '#3b82f6' }, /* blue-500, antes strategic */
                'received': { label: 'Recibido', color: '#ef4444' }, /* red-500, antes crisis */
                'in_process': { label: 'En Proceso', color: '#f59e0b' }, /* amber-500, antes interruptions */
                'finished': { label: 'Finalizado', color: '#64748b' } /* slate-500, antes distractions */
            };
            const statusMap = { // Este mapa de estado se mantiene igual
                'backlog': { label: 'Backlog', color: '#f59e0b' },
                'focus': { label: 'Foco Semana', color: '#3b82f6' },
                'progress': { label: 'En Progreso', color: '#ef4444' },
                'done': { label: 'Finalizado', color: '#10b981' } /* emerald-500 */
            };
            const lightColor = 'rgba(230, 230, 230, 0.8)'; // Color claro para texto en gr√°ficos
            const gridColor = 'rgba(255, 255, 255, 0.2)'; // Color de rejilla en gr√°ficos
            let allTasks = []; // Este array ahora se poblar√° desde la Google Sheet

            // Credenciales hardcoded (no seguro para producci√≥n, pero como solicitado)
            const users = {
                'rduran': 'rd1234',
                'hcortes': 'hc1234',
                'giturra': 'gi1234',
                'tgonzales': 'tg1234',
                'jvergara': 'jv1234',
                'raravena': 'ra1234',
                'msepulveda': 'ms1234',
                'ysanmartin': 'ys1234'
                'matenas': 'ma1234',
                'mmartinez': 'mm1234',
                'jvergara': 'jv1234'
            };

            // Manejar login
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value.toLowerCase();
                const password = document.getElementById('password').value;
                if (users[username] && users[username] === password) {
                    loginModal.style.display = 'none';
                    mainContent.style.display = 'block';
                    loadAllTasks(); // Cargar tareas despu√©s de login
                } else {
                    alert('Usuario o contrase√±a incorrectos');
                }
            });

            // --- FUNCIONES PARA INTERACTUAR CON GOOGLE APPS SCRIPT ---
            async function fetchData(action, taskData = {}) {
                try {
                    const url = APPS_SCRIPT_WEB_APP_URL + '?action=' + action; // Para GET requests
                    const options = {
                        method: action === 'read' ? 'GET' : 'POST',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8' // Es importante para Apps Script
                        },
                        body: action === 'read' ? null : JSON.stringify({ action: action, task: taskData })
                    };
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error fetching data:', error);
                    alert('Error al comunicar con el servidor: ' + error.message);
                    return null;
                }
            }
            // Funci√≥n para cargar todas las tareas desde Google Sheet
            async function loadAllTasks() {
                const data = await fetchData('read');
                // Aseg√∫rate de que los datos sean un array v√°lido. Si no lo son, se inicializa `allTasks` como vac√≠o.
                if (data && Array.isArray(data)) {
                    allTasks = data.map(task => ({
                        ...task,
                        // Asegurar que las fechas vac√≠as sean string vac√≠os para evitar 'null' o 'undefined'
                        completionDate: task.completionDate || '',
                        // Asegurar que lastModified sea una cadena de fecha v√°lida
                        lastModified: task.lastModified || new Date().toISOString(),
                        // Asegurar que requester exista
                        requester: task.requester || '',
                        deadline: task.deadline || '',
                        creationDate: task.creationDate || ''
                    }));
                    // Ordenar por lastModified desde el principio (las m√°s recientes primero)
                    allTasks.sort((a, b) => new Date(b.lastModified).getTime() - new Date(a.lastModified).getTime());
                } else {
                    console.warn('No se pudieron cargar las tareas desde Google Sheet o los datos no son v√°lidos. Inicializando con array vac√≠o.');
                    allTasks = []; // Asegura que allTasks est√© vac√≠o si hay un problema
                }
                // Siempre renderiza y actualiza los dashboards y la tabla despu√©s de intentar cargar las tareas
                renderTasksToKanban();
                updateAll();
                updateLastTasksSection(); // Actualizar secci√≥n de √∫ltimas tareas
            }
            // Renderiza las tareas del array allTasks a las columnas Kanban
            function renderTasksToKanban() {
                // Limpiar todas las columnas primero para evitar duplicados visuales
                document.getElementById('backlog-tasks').innerHTML = '';
                document.getElementById('focus-tasks').innerHTML = '';
                document.getElementById('progress-tasks').innerHTML = '';
                document.getElementById('done-tasks').innerHTML = '';
                allTasks.forEach(task => {
                    const card = document.createElement('div');
                    card.className = 'task-card bg-white p-2 rounded-lg shadow border-l-4';
                    card.draggable = true;
                   
                    // Aseg√∫rate de que task.status exista y sea v√°lido para un id de columna
                    const targetColumnId = task.status && document.getElementById(`${task.status}-tasks`) ? `${task.status}-tasks` : 'backlog-tasks';
                   
                    updateTaskCardDisplay(card, task); // Usar los datos existentes, incluyendo fechas y lastModified
                    document.getElementById(targetColumnId).appendChild(card);
                    setupTaskCard(card);
                   
                    // Asegurar que las tareas iniciales en 'done' tengan el estilo correcto
                    if (task.status === 'done') {
                        card.classList.add('opacity-70');
                        card.querySelector('h3').classList.add('line-through');
                        card.querySelector('p').classList.add('line-through');
                    }
                });
            }
            // --- FIN FUNCIONES DE INTERACCI√ìN ---
            // Funci√≥n principal para actualizar todos los componentes de la UI y datos
            function updateAll() {
                updateCharts();
                updateTaskTable();
            }
            // Actualiza todos los gr√°ficos del dashboard
            function updateCharts() {
                // Destruye gr√°ficos existentes para evitar conflictos al re-renderizar
                Object.values(charts).forEach(chart => chart.destroy());
                const statusCounts = { backlog: 0, focus: 0, progress: 0, done: 0 };
                allTasks.forEach(task => {
                    if (statusCounts.hasOwnProperty(task.status)) { // Asegura que el estado existe en el mapa
                        statusCounts[task.status]++;
                    } else {
                        console.warn(`Estado desconocido encontrado: ${task.status}. Ignorando en gr√°ficos de estado.`);
                    }
                });
                charts.status = new Chart(document.getElementById('statusChart'), {
                    type: 'bar',
                    data: {
                        labels: Object.values(statusMap).map(s => s.label),
                        datasets: [{ data: Object.values(statusCounts), backgroundColor: Object.values(statusMap).map(s => s.color) }]
                    },
                    options: getChartOptions()
                });
                const assigneeCounts = allTasks.reduce((acc, task) => {
                    if (task.responsible) acc[task.responsible] = (acc[task.responsible] || 0) + 1;
                    return acc;
                }, {});
                charts.assignee = new Chart(document.getElementById('assigneeChart'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(assigneeCounts),
                        datasets: [{
                            data: Object.values(assigneeCounts),
                            // Asigna colores de categoryMap, y a√±ade algunos extras si hay m√°s responsables que categor√≠as
                            backgroundColor: Object.values(categoryMap).map(c => c.color).concat(['#eab308', '#ec4899', '#14b8a6', '#9333ea', '#db2777'])
                        }]
                    },
                    options: getChartOptions(true)
                });
                const monthlyData = getMonthlyTaskData(allTasks);
                charts.monthlyTasks = new Chart(document.getElementById('monthlyTasksChart'), {
                    type: 'line',
                    data: {
                        labels: monthlyData.labels,
                        datasets: [
                            {
                                label: 'Tareas Creadas',
                                data: monthlyData.created,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'Tareas Finalizadas',
                                data: monthlyData.completed,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: lightColor, boxWidth: 12 } }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: lightColor, stepSize: 1 },
                                grid: { color: gridColor }
                            },
                            x: {
                                ticks: { color: lightColor },
                                grid: { color: gridColor }
                            }
                        }
                    }
                });
                // Nuevo gr√°fico: Estado de Avance por Responsable (barras apiladas)
                const progressByAssignee = getProgressByAssigneeData(allTasks);
                charts.progressByAssignee = new Chart(document.getElementById('progressByAssigneeChart'), {
                    type: 'bar',
                    data: {
                        labels: progressByAssignee.labels,
                        datasets: progressByAssignee.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: lightColor, boxWidth: 12 } }
                        },
                        scales: {
                            x: { stacked: true, ticks: { color: lightColor }, grid: { color: gridColor } },
                            y: { stacked: true, beginAtZero: true, ticks: { color: lightColor, stepSize: 1 }, grid: { color: gridColor } }
                        }
                    }
                });
                // Nuevo gr√°fico: Estad√≠stico de Resultados (Tasa de Finalizaci√≥n por Responsable)
                const completionRates = getCompletionRates(allTasks);
                charts.completionRate = new Chart(document.getElementById('completionRateChart'), {
                    type: 'bar',
                    data: {
                        labels: completionRates.labels,
                        datasets: [{
                            label: 'Tasa de Finalizaci√≥n (%)',
                            data: completionRates.rates,
                            backgroundColor: '#10b981'
                        }]
                    },
                    options: getChartOptions()
                });
            }
            function getChartOptions(isDoughnut = false) {
                const legendOptions = isDoughnut ? { position: 'right' } : { display: false };
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { ...legendOptions, labels: { color: lightColor, boxWidth: 12 } }
                    },
                    scales: isDoughnut ? {} : {
                        y: { beginAtZero: true, ticks: { color: lightColor, stepSize: 1 }, grid: { color: gridColor } },
                        x: { ticks: { color: lightColor }, grid: { color: gridColor } }
                    }
                };
            }
            function getMonthlyTaskData(tasks) {
                const today = new Date();
                const year = today.getFullYear();
                const monthNames = [
                    'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun',
                    'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'
                ];
                const createdByMonth = new Array(12).fill(0);
                const completedByMonth = new Array(12).fill(0);
                tasks.forEach(task => {
                    if (task.creationDate) {
                        const creationDate = new Date(task.creationDate);
                        // Aseg√∫rate de que el a√±o sea el actual para el conteo mensual
                        if (creationDate.getFullYear() === year) {
                            createdByMonth[creationDate.getMonth()]++;
                        }
                    }
                    if (task.status === 'done' && task.completionDate) {
                        const completionDate = new Date(task.completionDate);
                        // Aseg√∫rate de que el a√±o sea el actual para el conteo mensual
                        if (completionDate.getFullYear() === year) {
                            completedByMonth[completionDate.getMonth()]++;
                        }
                    }
                });
                return {
                    labels: monthNames,
                    created: createdByMonth,
                    completed: completedByMonth
                };
            }
            function getProgressByAssigneeData(tasks) {
                const assignees = [...new Set(tasks.map(task => task.responsible))];
                const datasets = Object.keys(statusMap).map(status => ({
                    label: statusMap[status].label,
                    data: assignees.map(assignee => tasks.filter(t => t.responsible === assignee && t.status === status).length),
                    backgroundColor: statusMap[status].color
                }));
                return { labels: assignees, datasets };
            }
            function getCompletionRates(tasks) {
                const assignees = [...new Set(tasks.map(task => task.responsible))];
                const rates = assignees.map(assignee => {
                    const assigneeTasks = tasks.filter(t => t.responsible === assignee);
                    const completed = assigneeTasks.filter(t => t.status === 'done').length;
                    return assigneeTasks.length > 0 ? (completed / assigneeTasks.length) * 100 : 0;
                });
                return { labels: assignees, rates };
            }
            function updateTaskTable() {
                const tableBody = document.getElementById('task-table-body');
                tableBody.innerHTML = '';
                allTasks.forEach(task => {
                    const statusInfo = statusMap[task.status] || {label: 'Desconocido', color: '#cccccc'}; // Fallback si el estado es desconocido
                    const categoryInfo = categoryMap[task.category] || {label: 'Desconocido', color: '#cccccc'}; // Fallback si la categor√≠a es desconocida
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-slate-50 cursor-pointer';
                    row.dataset.taskId = task.id;
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-slate-900">${task.title || ''}</td>
                        <td class="px-6 py-4">${task.responsible || ''}</td>
                        <td class="px-6 py-4">${task.requester || ''}</td>
                        <td class="px-6 py-4">${task.creationDate || 'N/A'}</td>
                        <td class="px-6 py-4">${task.deadline || 'N/A'}</td>
                        <td class="px-6 py-4">${task.completionDate || 'N/A'}</td>
                        <td class="px-6 py-4">${categoryInfo.label}</td>
                        <td class="px-6 py-4"><span class="status-badge" style="background-color: ${statusInfo.color};">${statusInfo.label}</span></td>`;
                    tableBody.appendChild(row);

                    // Evento click para abrir modal de detalles
                    row.addEventListener('click', () => {
                        showTaskDetails(task);
                    });
                });
            }

            // Funci√≥n para mostrar detalles de tarea en modal
            function showTaskDetails(task) {
                const detailBody = document.getElementById('taskDetailBody');
                detailBody.innerHTML = `
                    <p><strong>T√≠tulo:</strong> ${task.title}</p>
                    <p><strong>Descripci√≥n:</strong> ${task.description}</p>
                    <p><strong>Responsable:</strong> ${task.responsible}</p>
                    <p><strong>Solicitante:</strong> ${task.requester}</p>
                    <p><strong>Fecha Asignaci√≥n:</strong> ${task.creationDate || 'N/A'}</p>
                    <p><strong>Fecha L√≠mite:</strong> ${task.deadline || 'N/A'}</p>
                    <p><strong>Fecha Finalizaci√≥n:</strong> ${task.completionDate || 'N/A'}</p>
                    <p><strong>Categor√≠a:</strong> ${categoryMap[task.category]?.label || 'Desconocido'}</p>
                    <p><strong>Estado:</strong> ${statusMap[task.status]?.label || 'Desconocido'}</p>
                `;
                taskDetailModal.style.display = 'flex';
            }

            // Cerrar modal de detalles
            closeDetailBtn.addEventListener('click', () => {
                taskDetailModal.style.display = 'none';
            });
            taskDetailModal.addEventListener('click', (e) => {
                if (e.target === taskDetailModal) taskDetailModal.style.display = 'none';
            });

            // Funci√≥n para actualizar secci√≥n de √∫ltimas 2 tareas
            function updateLastTasksSection() {
                const lastTasksList = document.getElementById('lastTasksList');
                lastTasksList.innerHTML = '';
                const lastTwoTasks = allTasks.slice(0, 2); // Las 2 m√°s recientes (ya ordenadas por lastModified)
                lastTwoTasks.forEach(task => {
                    const li = document.createElement('li');
                    li.className = 'text-xs text-slate-700';
                    li.textContent = `${task.title} (${task.creationDate})`;
                    lastTasksList.appendChild(li);
                });
            }

            // Funci√≥n para calcular el countdown (d√≠as restantes)
            function calculateCountdown(deadline) {
                if (!deadline) return '';
                const today = new Date();
                const limitDate = new Date(deadline);
                const timeDiff = limitDate - today;
                const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                if (daysLeft > 0) {
                    return `(${daysLeft} d√≠as restantes)`;
                } else if (daysLeft === 0) {
                    return '(Hoy)';
                } else {
                    return `(Vencida por ${Math.abs(daysLeft)} d√≠as)`;
                }
            }
            // Funci√≥n que actualiza los data-atributos y el display visual de una tarjeta
            function updateTaskCardDisplay(card, data) {
                card.dataset.id = data.id || `task-${Date.now()}`; // Asigna un ID si no tiene
                Object.keys(data).forEach(key => { card.dataset[key] = data[key]; }); // Actualiza todos los data-atributos
               
                // Usa un color por defecto si la categor√≠a no se encuentra
                const cardCategoryColor = categoryMap[data.category] ? categoryMap[data.category].color : '#cccccc';
                card.style.borderLeftColor = cardCategoryColor; // Color del borde seg√∫n categor√≠a
                const countdown = calculateCountdown(data.deadline);
                const deadlineText = data.deadline ? `<b>L√≠mite:</b> ${data.deadline} ${countdown}` : '';
                // Si la fecha l√≠mite ha pasado y la tarea no est√° finalizada, a√±adir clase para destacar
                if (data.deadline && new Date(data.deadline) < new Date() && data.status !== 'done') {
                    card.classList.add('deadline-passed');
                } else {
                    card.classList.remove('deadline-passed');
                }
                card.innerHTML = `
                    <h3 class="font-semibold text-sm leading-tight">${data.title}</h3>
                    <p class="text-xs text-slate-600 mt-1">${data.description}</p>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-xs text-slate-500 font-medium">Responsable: ${data.responsible}</span>
                        <span class="text-xs text-slate-500 font-medium">Solicitante: ${data.requester}</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-xs text-slate-500"><b>Creaci√≥n:</b> ${data.creationDate}</span>
                        <span class="text-xs text-slate-500 ${countdown.includes('Vencida') ? 'text-red-500 font-bold' : ''}">${deadlineText}</span>
                    </div>
                    <button class="delete-btn" data-id="${data.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.58.275-2.314.593A3.31 3.31 0 0 0 3 6.03V16.5A3.25 3.25 0 0 0 6.25 19h7.5A3.25 3.25 0 0 0 17 16.5V6.03c0-.795-.352-1.51-1.006-1.992-.734-.318-1.52-.516-2.314-.593V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.828 0 1.5.672 1.5 1.5V6h-3V5.5c0-.828.672-1.5 1.5-1.5ZM9 8.25a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75Zm3.25 0a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    `;
               
                // Actualizar el estilo de tachado y opacidad si est√° en la columna 'done'
                const isDone = data.status === 'done';
                card.classList.toggle('opacity-70', isDone);
                card.querySelector('h3').classList.toggle('line-through', isDone);
                card.querySelector('p').classList.toggle('line-through', isDone);
                // A√±adir event listener al bot√≥n de eliminar (DELEGACI√ìN DE EVENTOS)
                const deleteButton = card.querySelector('.delete-btn');
                deleteButton.addEventListener('click', async (event) => {
                    // Prevenir que el clic se propague al evento de arrastrar de la tarjeta
                    event.stopPropagation();
                    if (confirm('¬øEst√°s seguro de que quieres eliminar esta tarea permanentemente?')) {
                        const taskIdToDelete = deleteButton.dataset.id;
                        const result = await fetchData('delete', { id: taskIdToDelete });
                        if (result && result.success) {
                            console.log('Task deleted from Sheet:', taskIdToDelete);
                            await loadAllTasks(); // Recarga para sincronizar la UI
                        } else {
                            alert('Error al eliminar la tarea: ' + (result?.message || 'Error desconocido'));
                        }
                    }
                });
            }
            // Modificada para persistencia
            async function createTask(data) {
                data.creationDate = data.creationDate || new Date().toISOString().split('T')[0];
                data.completionDate = data.completionDate || '';
                data.lastModified = new Date().toISOString();
                data.status = 'backlog'; // Las nuevas tareas siempre empiezan en backlog
                data.id = `task-${Date.now()}`;
                const result = await fetchData('create', data);
                if (result && result.success) {
                    console.log('Task created on Sheet:', result.task);
                    await loadAllTasks(); // Recargar todas las tareas para reflejar el cambio y mantener la sincronizaci√≥n
                } else {
                    alert('Error al crear la tarea: ' + (result?.message || 'Error desconocido'));
                }
            }
            // Modificada para persistencia
            async function updateTaskData(taskData) { // Ahora recibe directamente el objeto de datos de la tarea
                taskData.lastModified = new Date().toISOString(); // Actualiza la fecha de modificaci√≥n
                const result = await fetchData('update', taskData);
                if (result && result.success) {
                    console.log('Task updated on Sheet:', result.task);
                    await loadAllTasks(); // Recargar todas las tareas para reflejar el cambio y mantener la sincronizaci√≥n
                } else {
                    console.error('Failed to update task on Sheet.');
                    alert('Error al actualizar la tarea: ' + (result?.message || 'Error desconocido'));
                }
            }
            function openModal(mode = 'add', taskCard = null) {
                taskForm.reset();
                document.getElementById('modalTitle').textContent = mode === 'edit' ? 'Editar Tarea' : 'A√±adir Tarea';
                if (mode === 'edit' && taskCard) {
                    taskForm.querySelector('#task-id').value = taskCard.dataset.id;
                    taskForm.querySelector('#taskTitle').value = taskCard.dataset.title;
                    taskForm.querySelector('#taskDesc').value = taskCard.dataset.description;
                    taskForm.querySelector('#taskResponsible').value = taskCard.dataset.responsible;
                    taskForm.querySelector('#taskRequester').value = taskCard.dataset.requester;
                    taskForm.querySelector('#taskDeadline').value = taskCard.dataset.deadline;
                    taskForm.querySelector('#taskCategory').value = taskCard.dataset.category;
                    taskForm.querySelector('#task-creation-date').value = taskCard.dataset.creationDate;
                    taskForm.querySelector('#task-completion-date').value = taskCard.dataset.completionDate || '';
                } else {
                    taskForm.querySelector('#task-id').value = '';
                    taskForm.querySelector('#task-creation-date').value = new Date().toISOString().split('T')[0];
                    taskForm.querySelector('#task-completion-date').value = '';
                }
                taskModal.style.display = 'flex';
            }
            function setupTaskCard(item) {
                item.addEventListener('dragstart', () => {
                    draggedItem = item;
                    setTimeout(() => item.classList.add('dragging'), 0);
                });
                item.addEventListener('dragend', async () => { // Async aqu√≠
                    draggedItem = null;
                    item.classList.remove('dragging');
                    // updateAll() se llamar√° despu√©s de que la tarea se haya actualizado en la Sheet
                });
                // El evento contextmenu sigue ah√≠ para el men√∫ contextual, pero el bot√≥n de eliminar es m√°s directo.
                item.addEventListener('contextmenu', e => {
                    e.preventDefault();
                    e.stopPropagation();
                    currentContextMenuTask = item;
                    contextMenu.style.top = `${e.pageY}px`;
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.display = 'block';
                });
            }
           
            document.querySelectorAll('.kanban-column').forEach(col => {
                col.addEventListener('dragover', e => {
                    e.preventDefault();
                    col.classList.add('drag-over');
                });
                col.addEventListener('dragleave', () => {
                    col.classList.remove('drag-over');
                });
                col.addEventListener('drop', async e => { // Async aqu√≠
                    e.preventDefault();
                    col.classList.remove('drag-over');
                    if (draggedItem) {
                        const targetContainer = col.querySelector('.task-container');
                        targetContainer.insertBefore(draggedItem, targetContainer.firstChild);
                       
                        // Prepara los datos de la tarea para actualizar
                        const taskData = {
                            id: draggedItem.dataset.id,
                            title: draggedItem.dataset.title,
                            description: draggedItem.dataset.description,
                            responsible: draggedItem.dataset.responsible,
                            requester: draggedItem.dataset.requester,
                            deadline: draggedItem.dataset.deadline,
                            category: draggedItem.dataset.category,
                            creationDate: draggedItem.dataset.creationDate,
                            // Actualizar completionDate y status
                            status: col.id,
                            completionDate: (col.id === 'done') ? new Date().toISOString().split('T')[0] : '',
                        };
                       
                        // Llama a updateTaskData para persistir el cambio de status y fecha
                        await updateTaskData(taskData);
                    }
                });
            });
            document.getElementById('addTaskBtn').addEventListener('click', () => openModal('add'));
            document.getElementById('cancelBtn').addEventListener('click', () => taskModal.style.display = 'none');
            taskModal.addEventListener('click', e => {
                if (e.target === taskModal) taskModal.style.display = 'none';
            });
            taskForm.addEventListener('submit', async e => { // Async aqu√≠
                e.preventDefault();
                const id = taskForm.querySelector('#task-id').value;
                const data = {
                    title: taskForm.querySelector('#taskTitle').value,
                    description: taskForm.querySelector('#taskDesc').value,
                    responsible: taskForm.querySelector('#taskResponsible').value,
                    requester: taskForm.querySelector('#taskRequester').value,
                    deadline: taskForm.querySelector('#taskDeadline').value,
                    category: taskForm.querySelector('#taskCategory').value,
                    creationDate: taskForm.querySelector('#task-creation-date').value,
                    completionDate: taskForm.querySelector('#task-completion-date').value
                };
                if (id) {
                    // Editar tarea existente
                    // Incluye el ID y el status actual para la actualizaci√≥n
                    data.id = id;
                    data.status = document.querySelector(`[data-id="${id}"]`).dataset.status;
                    await updateTaskData(data);
                } else {
                    // Crear nueva tarea
                    await createTask(data);
                }
                taskModal.style.display = 'none';
                // updateAll() se llamar√° al final de createTask/updateTaskData
            });
           
            contextMenu.addEventListener('click', e => e.stopPropagation());
            window.addEventListener('click', () => contextMenu.style.display = 'none');
            document.getElementById('editTaskBtn').addEventListener('click', () => {
                if (currentContextMenuTask) {
                    openModal('edit', currentContextMenuTask);
                    contextMenu.style.display = 'none';
                }
            });
            // Este bot√≥n de eliminar en el men√∫ contextual sigue funcionando como alternativa.
            document.getElementById('deleteTaskBtn').addEventListener('click', async () => { // Async aqu√≠
                if (currentContextMenuTask) {
                    if (confirm('¬øEst√°s seguro de que quieres eliminar esta tarea permanentemente?')) {
                        const taskIdToDelete = currentContextMenuTask.dataset.id;
                        const result = await fetchData('delete', { id: taskIdToDelete });
                        if (result && result.success) {
                            console.log('Task deleted from Sheet:', taskIdToDelete);
                            await loadAllTasks(); // Recarga para sincronizar la UI
                        } else {
                            alert('Error al eliminar la tarea: ' + (result?.message || 'Error desconocido'));
                        }
                        contextMenu.style.display = 'none';
                    }
                }
            });
        });

        function filtrarTablaPorResponsable() {
            var input = document.getElementById("filtro-responsable");
            var filtro = input.value.toLowerCase();
            var tableBody = document.getElementById("task-table-body");
            var rows = tableBody.getElementsByTagName("tr");

            for (var i = 0; i < rows.length; i++) {
                var responsableCell = rows[i].getElementsByTagName("td")[1]; // Segunda columna: Responsable (√≠ndice 1)
                if (responsableCell) {
                    var texto = responsableCell.textContent || responsableCell.innerText;
                    if (texto.toLowerCase().indexOf(filtro) > -1) {
                        rows[i].style.display = "";
                    } else {
                        rows[i].style.display = "none";
                    }
                }
            }
        }
    </script>
</body>
</html>